---
name: Benchmarks
permissions: {}
"on":
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  evm-benchmark:
    name: EVM Contract Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: ./go.mod
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
      - name: Build binaries
        run: make build-evm build-da
      - name: Run EVM benchmarks
        run: |
          cd test/e2e && go test -tags evm -bench=. -benchmem -run='^$' \
            -timeout=10m --evm-binary=../../build/evm | tee output.txt
      # only update the benchmark baseline on push/dispatch, not on PRs
      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@4bdcce38c94cec68da58d012ac24b7b1155efe8b # v1.20.7
        with:
          name: EVM Contract Roundtrip
          tool: 'go'
          output-file-path: test/e2e/output.txt
          auto-push: ${{ github.event_name != 'pull_request' }}
          save-data-file: ${{ github.event_name != 'pull_request' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          alert-threshold: '150%'
          fail-on-alert: true
          comment-on-alert: true

      - name: Run Block Executor benchmarks
        run: |
          go test -bench=BenchmarkProduceBlock -benchmem -run='^$' \
            ./block/internal/executing/... > block_executor_output.txt
      # only update the benchmark baseline on push/dispatch, not on PRs
      - name: Store Block Executor benchmark result
        uses: benchmark-action/github-action-benchmark@4bdcce38c94cec68da58d012ac24b7b1155efe8b # v1.20.7
        with:
          name: Block Executor Benchmark
          tool: 'go'
          output-file-path: block_executor_output.txt
          auto-push: ${{ github.event_name != 'pull_request' }}
          save-data-file: ${{ github.event_name != 'pull_request' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          alert-threshold: '150%'
          fail-on-alert: true
          comment-on-alert: true

  spamoor-benchmark:
    name: Spamoor Trace Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: ./go.mod
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
      - name: Build binaries
        run: make build-evm build-da
      - name: Run Spamoor smoke test
        run: |
          cd test/e2e && BENCH_JSON_OUTPUT=spamoor_bench.json go test -tags evm \
            -run='^TestSpamoorSmoke$' -v -timeout=15m --evm-binary=../../build/evm
      # only update the benchmark baseline on push/dispatch, not on PRs
      - name: Store spamoor benchmark result
        uses: benchmark-action/github-action-benchmark@4bdcce38c94cec68da58d012ac24b7b1155efe8b # v1.20.7
        with:
          name: Spamoor Trace Benchmarks
          tool: 'customSmallerIsBetter'
          output-file-path: test/e2e/spamoor_bench.json
          auto-push: ${{ github.event_name != 'pull_request' }}
          save-data-file: ${{ github.event_name != 'pull_request' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          alert-threshold: '150%'
          fail-on-alert: true
          comment-on-alert: true
