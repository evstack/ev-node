import{_ as a,c as t,ag as o,o as s}from"./chunks/framework.CmpABV1Y.js";const r="/assets/header_shares_commit.BV-0Sonp.jpg",f=JSON.parse('{"title":"ADR 007: Commit to Shares in Header","description":"","frontmatter":{"head":[["meta",{"name":"og:title","content":"ADR 007: Commit to Shares in Header | Evolve"},{"name":"og:description","content":false}]]},"headers":[],"relativePath":"adr/adr-007-header-commit-to-shares.md","filePath":"adr/adr-007-header-commit-to-shares.md","lastUpdated":1753438408000}'),i={name:"adr/adr-007-header-commit-to-shares.md"};function n(l,e,h,d,c,m){return s(),t("div",null,e[0]||(e[0]=[o('<h1 id="adr-007-commit-to-shares-in-header" tabindex="-1">ADR 007: Commit to Shares in Header <a class="header-anchor" href="#adr-007-commit-to-shares-in-header" aria-label="Permalink to &quot;ADR 007: Commit to Shares in Header&quot;">​</a></h1><h2 id="changelog" tabindex="-1">Changelog <a class="header-anchor" href="#changelog" aria-label="Permalink to &quot;Changelog&quot;">​</a></h2><ul><li>2021-10-01: Initial draft</li></ul><h2 id="context" tabindex="-1">Context <a class="header-anchor" href="#context" aria-label="Permalink to &quot;Context&quot;">​</a></h2><ol><li>Only <a href="https://github.com/celestiaorg/celestia-specs/blob/master/src/specs/data_structures.md#header" target="_blank" rel="noreferrer">a single data root must be included in the Celestia block header</a>; if more than one data root is included, light nodes will not have any guarantees that the data behind the other data roots is available unless they run a separate sampling process per data root.</li><li><a href="https://github.com/celestiaorg/celestia-specs/blob/master/src/specs/data_structures.md#signedtransactiondatapayformessage" target="_blank" rel="noreferrer">PayForMessage transactions</a> include a commitment of roots of subtrees of the Celestia data root. This is a requirement for compact proofs that a message was or was not included correctly.</li><li><a href="https://github.com/celestiaorg/celestia-specs/blob/master/src/specs/networking.md#wiretxpayformessage" target="_blank" rel="noreferrer">Over the wire</a>, PayForMessage transactions include (potentially) multiple signatures for the same message with different sizes of Celestia block, to allow for <a href="https://github.com/celestiaorg/celestia-specs/blob/master/src/rationale/message_block_layout.md#non-interactive-default-rules" target="_blank" rel="noreferrer">non-interactive message inclusion</a>.</li></ol><p>Blocks must follow a similar strategy to the above. Specifically, the data root in block headers <a href="https://github.com/evstack/ev-node/issues/133" target="_blank" rel="noreferrer">must commit to subtree roots in the Celestia data root</a>, otherwise nodes would not have any guarantees that the data behind the data root in a block header is available.</p><h2 id="alternative-approaches" tabindex="-1">Alternative Approaches <a class="header-anchor" href="#alternative-approaches" aria-label="Permalink to &quot;Alternative Approaches&quot;">​</a></h2><h3 id="alternative-1-don-t-commit-to-data-root-in-block-header" tabindex="-1">Alternative 1: Don&#39;t Commit to Data Root in Block Header <a class="header-anchor" href="#alternative-1-don-t-commit-to-data-root-in-block-header" aria-label="Permalink to &quot;Alternative 1: Don&#39;t Commit to Data Root in Block Header&quot;">​</a></h3><p>One proposal is to simply not include any commitment to data in the block header, and use the <code>MessageShareCommitment</code> field in the respective PayForMessage transaction to commit to <em>both</em> the block header and block data.</p><p>This may only work securely under certain scenarios, but not in the general case. Since block data is not committed to in the block header, it will not be signed over by the block producer set (e.g. if the block producers are using a Tendermint-like protocol) and can therefore be malleated by these parties.</p><h3 id="alternative-2-one-message-per-layout" tabindex="-1">Alternative 2: One Message Per Layout <a class="header-anchor" href="#alternative-2-one-message-per-layout" aria-label="Permalink to &quot;Alternative 2: One Message Per Layout&quot;">​</a></h3><p>Another proposal is having the block header commit to subtree roots. However, since the layout of shares (and thus, the subtree structures) might change depending on the size of the data square, this means the message that is paid for in PayForMessage is different depending on the layout (since the message includes the block header).</p><p>A different message can be included per witness for PayForMessage transactions over the wire. This would lead to unacceptably high networking overhead unfortunately, since messages are expected to be quite large individually.</p><h3 id="alternative-3-auction-off-rows-instead-of-shares" tabindex="-1">Alternative 3: Auction Off Rows Instead of Shares <a class="header-anchor" href="#alternative-3-auction-off-rows-instead-of-shares" aria-label="Permalink to &quot;Alternative 3: Auction Off Rows Instead of Shares&quot;">​</a></h3><p>Instead of auctioning off individual shares, rows can be auctioned off entirely. In other words, only a single message can be included per row (though a message may span more than one row), and always begins at the start of a row. This will also simplify various codepaths that no longer need to account for the potential of multiple messages and namespaces per row.</p><p>This would not solve anything since the size of the square will still change, and is also a design pivot. It is not yet decided whether this pivot is worth taking.</p><p>An alternative to this alternative would be to make the block size fixed. Combined with auctioning off rows, this would enormously simplify message inclusion logic.</p><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to &quot;Decision&quot;">​</a></h2><p>Resolving this issue is accomplished with two components.</p><p>First, the transactions are committed to <em>in share form and layout</em> in the block header, similar to the commitment in PayForMessage. For this, only transactions are committed to, and begin aligned with power of 2 shares. This commitment will be different than the one in the PayForMessage transaction that pays for this message since that commits to both the transactions and block header. A new block header and commitment is constructed for each of the different block sizes possible.</p><p>To preserve the property that transactions begin aligned at a power of 2 boundary, we append the block header <em>after</em> the transactions, effectively turning it into a footer. Instead of downloading the first X shares of each message to extract the header for DoS prevention, nodes will instead download the last X shares of each message.</p><p>In order to avoid having to include many different messages with PayForMessage over the wire, we modify the WirePayForMessage structure to include a new field, <code>footers</code>. The number of footers must be equal to the number of witnesses. When verifying each witness, the associated footer is appended to the message, which combined is the effective message.</p><p><img src="'+r+'" alt="Proposal."></p><h2 id="detailed-design" tabindex="-1">Detailed Design <a class="header-anchor" href="#detailed-design" aria-label="Permalink to &quot;Detailed Design&quot;">​</a></h2><h2 id="status" tabindex="-1">Status <a class="header-anchor" href="#status" aria-label="Permalink to &quot;Status&quot;">​</a></h2><p>Discarded</p><h2 id="consequences" tabindex="-1">Consequences <a class="header-anchor" href="#consequences" aria-label="Permalink to &quot;Consequences&quot;">​</a></h2><h3 id="positive" tabindex="-1">Positive <a class="header-anchor" href="#positive" aria-label="Permalink to &quot;Positive&quot;">​</a></h3><h3 id="negative" tabindex="-1">Negative <a class="header-anchor" href="#negative" aria-label="Permalink to &quot;Negative&quot;">​</a></h3><h3 id="neutral" tabindex="-1">Neutral <a class="header-anchor" href="#neutral" aria-label="Permalink to &quot;Neutral&quot;">​</a></h3><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">​</a></h2><ol><li><a href="https://github.com/evstack/ev-node/issues/133" target="_blank" rel="noreferrer">https://github.com/evstack/ev-node/issues/133</a></li></ol>',32)]))}const p=a(i,[["render",n]]);export{f as __pageData,p as default};
